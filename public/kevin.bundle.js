(()=>{"use strict";class e{constructor(e={}){this.vad=null,this.mediaStream=null,this.callbacks=e,this.listening=!1,this.muted=!1}async initialize(){try{return this.vad=await vad.MicVAD.new({onSpeechStart:()=>{console.log("Parole détectée"),this.callbacks.onSpeechStart&&this.callbacks.onSpeechStart()},onSpeechEnd:e=>{console.log("Fin de parole"),!this.muted&&this.callbacks.onSpeechEnd&&this.callbacks.onSpeechEnd(e)},onVADMisfire:()=>{console.log("Fausse détection"),this.callbacks.onVADMisfire&&this.callbacks.onVADMisfire()}}),this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),!0}catch(e){return console.error("Erreur lors de l'initialisation du VAD:",e),this.callbacks.onError&&this.callbacks.onError(e),!1}}start(){this.vad&&(this.vad.start(),this.listening=!0)}pause(){this.vad&&(this.vad.pause(),this.listening=!1)}stop(){this.pause(),this.mediaStream&&this.mediaStream.getTracks().forEach((e=>e.stop())),this.listening=!1}setMute(e){this.muted=e,this.mediaStream&&this.mediaStream.getAudioTracks().forEach((t=>{t.enabled=!e}))}isListening(){return this.listening}isMuted(){return this.muted}}class t{static floatTo16BitPCM(e,t,s){for(let n=0;n<s.length;n++,t+=2){const r=Math.max(-1,Math.min(1,s[n]));e.setInt16(t,r<0?32768*r:32767*r,!0)}}static writeString(e,t,s){for(let n=0;n<s.length;n++)e.setUint8(t+n,s.charCodeAt(n))}static encodeWAV(e,t=16e3){const s=new ArrayBuffer(44+2*e.length),n=new DataView(s);return this.writeString(n,0,"RIFF"),n.setUint32(4,36+2*e.length,!0),this.writeString(n,8,"WAVE"),this.writeString(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,1,!0),n.setUint32(24,t,!0),n.setUint32(28,2*t,!0),n.setUint16(32,2,!0),n.setUint16(34,16,!0),this.writeString(n,36,"data"),n.setUint32(40,2*e.length,!0),this.floatTo16BitPCM(n,44,e),s}static createWavBlob(e){const t=this.encodeWAV(e);return new Blob([t],{type:"audio/wav"})}}class s{constructor(){this.currentAbortController=null}async transcribe(e,s){if(!s)throw new Error("Aucune clé API fournie");this.currentAbortController=new AbortController;const n=this.currentAbortController.signal;try{const r=t.createWavBlob(e),o=new FormData;o.append("file",r,"audio.wav"),o.append("model","whisper-large-v3-turbo"),o.append("temperature","0"),o.append("response_format","json"),o.append("language","fr");const i=await fetch("https://api.groq.com/openai/v1/audio/transcriptions",{method:"POST",headers:{Authorization:`Bearer ${s}`},body:o,signal:n});if(!i.ok)throw new Error(`Erreur de transcription: ${i.status} - ${i.statusText}`);return(await i.json()).text}finally{this.currentAbortController=null}}cancel(){this.currentAbortController&&(this.currentAbortController.abort(),this.currentAbortController=null)}}class n{constructor(){this.messageHistory=[],this.currentAbortController=null}async sendMessage(e,t){if(!t)throw new Error("Aucune clé API fournie");this.messageHistory.push({role:"user",content:e}),this.currentAbortController=new AbortController;const s=this.currentAbortController.signal;try{const e=await fetch("https://api.groq.com/openai/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({messages:this.messageHistory,model:"gemma2-9b-it"}),signal:s});if(!e.ok)throw new Error(`Erreur de chat: ${e.status} - ${e.statusText}`);const n=await e.json();if(n.choices&&n.choices[0]&&n.choices[0].message)return this.messageHistory.push(n.choices[0].message),n.choices[0].message.content;throw new Error("Format de réponse invalide")}finally{this.currentAbortController=null}}cancel(){this.currentAbortController&&(this.currentAbortController.abort(),this.currentAbortController=null)}clearHistory(){this.messageHistory=[]}getHistory(){return[...this.messageHistory]}}class r{constructor(){this.currentAbortController=null,this.audioElement=document.getElementById("tts-player"),this.isSpeaking=!1,this.onSpeakingStarted=null,this.onSpeakingEnded=null,this.onSpeakingInterrupted=null,this.audioElement||(console.error("Élément audio non trouvé dans le DOM, création d'un élément temporaire"),this.audioElement=document.createElement("audio"),this.audioElement.id="tts-player",document.body.appendChild(this.audioElement)),this.setupAudioListeners()}setupAudioListeners(){this.audioElement.onplay=()=>{console.log("TTS: lecture démarrée"),this.isSpeaking=!0,this.onSpeakingStarted&&this.onSpeakingStarted()},this.audioElement.onended=()=>{console.log("TTS: lecture terminée"),this.isSpeaking=!1,this.onSpeakingEnded&&this.onSpeakingEnded()},this.audioElement.onerror=e=>{console.error("TTS: erreur de lecture",e),this.isSpeaking=!1,this.onSpeakingInterrupted&&this.onSpeakingInterrupted()},this.audioElement.onpause=()=>{this.isSpeaking&&(console.log("TTS: lecture mise en pause"),this.isSpeaking=!1,this.onSpeakingInterrupted&&this.onSpeakingInterrupted())}}async speak(e){if(!e)return Promise.resolve();this.currentAbortController=new AbortController;const t=this.currentAbortController.signal;try{console.log("TTS: Envoi de la requête de synthèse vocale");const s=await fetch("https://chatbot-20102024-8c94bbb4eddf.herokuapp.com/synthesize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,voice:"fr-FR-DeniseNeural"}),signal:t});if(!s.ok)throw new Error(`Erreur de synthèse vocale: ${s.status} - ${s.statusText}`);const n=await s.blob(),r=URL.createObjectURL(n);return this.audioElement.src&&URL.revokeObjectURL(this.audioElement.src),console.log("TTS: Audio reçu, configuration du lecteur"),this.audioElement.src=r,console.log("TTS: Tentative de lecture"),new Promise(((e,t)=>{const s=setTimeout((()=>{console.warn("TTS: Timeout de sécurité déclenché"),this.isSpeaking=!1,this.onSpeakingEnded&&this.onSpeakingEnded(),e()}),3e4),n=()=>{clearTimeout(s),this.audioElement.removeEventListener("ended",n),e()};this.audioElement.addEventListener("ended",n);const r=t=>{clearTimeout(s),this.audioElement.removeEventListener("error",r),console.error("TTS: Erreur lors de la lecture",t),e()};this.audioElement.addEventListener("error",r),this.audioElement.play().catch((t=>{clearTimeout(s),console.error("TTS: Impossible de démarrer la lecture",t),this.isSpeaking=!1,this.onSpeakingInterrupted&&this.onSpeakingInterrupted(),e()}))}))}catch(e){return console.error("TTS: Erreur générale",e),this.isSpeaking=!1,this.onSpeakingInterrupted&&this.onSpeakingInterrupted(),Promise.resolve()}finally{this.currentAbortController=null}}cancel(){this.currentAbortController&&(this.currentAbortController.abort(),this.currentAbortController=null),this.audioElement&&(this.audioElement.pause(),this.audioElement.currentTime=0,this.isSpeaking&&(console.log("TTS: Lecture interrompue manuellement"),this.isSpeaking=!1,this.onSpeakingInterrupted&&this.onSpeakingInterrupted()))}}class o{constructor(){this.elements={startButton:document.getElementById("start-button"),stopButton:document.getElementById("stop-button"),muteButton:document.getElementById("mute-button"),statusIndicator:document.getElementById("status-indicator"),statusText:document.getElementById("status-text"),segmentsCount:document.getElementById("segments-count"),segmentsList:document.getElementById("segments-list"),apiKeyInput:document.getElementById("api-key")},this.elements.stopButton&&(this.elements.stopButton.style.display="none")}updateUI(e,t=!1,s=!1){e?(this.elements.startButton.style.display="none",this.elements.stopButton.style.display="flex",this.elements.startButton.disabled=!0,this.elements.startButton.classList.add("bg-gray-300","text-gray-500","cursor-not-allowed"),this.elements.startButton.classList.remove("bg-blue-800","text-white","hover:bg-blue-900"),this.elements.stopButton.disabled=!1,this.elements.stopButton.classList.add("bg-red-500","text-white","hover:bg-red-600"),this.elements.stopButton.classList.remove("bg-slate-200","text-slate-400","cursor-not-allowed"),this.elements.muteButton.disabled=!1,this.elements.muteButton.classList.remove("cursor-not-allowed"),s?(this.elements.statusText.textContent="Traitement en cours...",this.elements.statusIndicator.classList.remove("bg-slate-200","bg-yellow-500","bg-green-500","bg-red-500"),this.elements.statusIndicator.classList.add("bg-blue-500")):(this.elements.statusText.textContent=t?"Parole détectée":"En attente de parole",this.elements.statusIndicator.classList.remove("bg-slate-200","bg-blue-500","bg-red-500"),this.elements.statusIndicator.classList.add(t?"bg-green-500":"bg-yellow-500"))):(this.elements.startButton.style.display="flex",this.elements.stopButton.style.display="none",this.elements.startButton.disabled=!1,this.elements.startButton.classList.remove("bg-gray-300","text-gray-500","cursor-not-allowed"),this.elements.startButton.classList.add("bg-blue-800","text-white","hover:bg-blue-900"),this.elements.stopButton.disabled=!0,this.elements.stopButton.classList.remove("bg-red-500","text-white","hover:bg-red-600"),this.elements.stopButton.classList.add("bg-slate-200","text-slate-400","cursor-not-allowed"),this.elements.muteButton.disabled=!0,this.elements.muteButton.classList.add("cursor-not-allowed"),this.elements.statusText.textContent="En attente de démarrer",this.elements.statusIndicator.classList.remove("bg-green-500","bg-yellow-500","bg-red-500","bg-blue-500"),this.elements.statusIndicator.classList.add("bg-slate-200"))}updateMuteState(e){e?(this.elements.muteButton.innerHTML='<i class="fas fa-microphone mr-2"></i>',this.elements.muteButton.classList.remove("bg-amber-500","hover:bg-amber-600"),this.elements.muteButton.classList.add("bg-green-500","hover:bg-green-600"),this.elements.statusIndicator.classList.remove("bg-yellow-500","bg-green-500"),this.elements.statusIndicator.classList.add("bg-red-500"),this.elements.statusText.textContent="Microphone coupé"):(this.elements.muteButton.innerHTML='<i class="fas fa-microphone-slash mr-2"></i>',this.elements.muteButton.classList.remove("bg-green-500","hover:bg-green-600"),this.elements.muteButton.classList.add("bg-amber-500","hover:bg-amber-600"),this.elements.statusIndicator.classList.remove("bg-red-500"),this.elements.statusIndicator.classList.add("bg-yellow-500"),this.elements.statusText.textContent="En attente de parole")}addSegment(e,t){this.elements.segmentsCount.textContent=e;const s=document.createElement("div");s.className="text-sm text-gray-700",s.textContent=`Segment #${e} - ${Math.round(100*t)/100}s`,this.elements.segmentsList.appendChild(s)}resetSegments(){this.elements.segmentsCount.textContent="0",this.elements.segmentsList.innerHTML=""}getApiKey(){return this.elements.apiKeyInput.value}setApiKey(e){this.elements.apiKeyInput.value=e}}class i{constructor(e){this.container=e}addPendingUserMessage(e){const t=document.createElement("div");return t.className="message user mb-6 flex justify-end",t.id=`message-${e}`,t.innerHTML=`\n            <div class="bg-blue-900 text-white p-4 rounded-2xl rounded-tr-none shadow-md max-w-[80%]">\n                <div><span class="inline-block animate-pulse">Transcription en cours...</span></div>\n                <div class="flex justify-end mt-1">\n                    <span class="text-xs text-blue-200">${(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</span>\n                </div>\n            </div>\n        `,this.container.appendChild(t),this.scrollToBottom(),t}updateUserMessage(e,t){const s=document.getElementById(`message-${e}`);if(s){const e=s.querySelector("div div:first-child");e.innerHTML="",e.textContent=t,e.classList.remove("animate-pulse")}this.scrollToBottom()}addPendingAssistantMessage(e){const t=document.createElement("div");return t.className="message assistant mb-6 flex justify-start",t.id=`response-${e}`,t.innerHTML=`\n            <div class="bg-slate-100 p-4 rounded-2xl rounded-tl-none shadow-sm max-w-[80%] text-slate-800">\n                <div><span class="inline-block animate-pulse">Génération de la réponse...</span></div>\n                <div class="flex justify-start mt-1">\n                    <span class="text-xs text-slate-500">${(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</span>\n                </div>\n            </div>\n        `,this.container.appendChild(t),this.scrollToBottom(),t}updateAssistantMessage(e,t){const s=document.getElementById(`response-${e}`);if(s){const e=s.querySelector("div div:first-child");e.innerHTML="",e.textContent=t,e.classList.remove("animate-pulse")}this.scrollToBottom()}addInfoMessage(e,t="info"){const s=document.createElement("div");s.className=`p-3 mb-4 ${{info:"bg-slate-200 text-slate-800",error:"bg-red-100 text-red-800",success:"bg-green-100 text-green-800",warning:"bg-amber-100 text-amber-800"}[t]} rounded-md text-center text-sm max-w-[80%] mx-auto shadow-sm`,s.textContent=e,this.container.appendChild(s),this.scrollToBottom()}scrollToBottom(){this.container.scrollTop=this.container.scrollHeight}addUserTextMessage(e,t){const s=document.createElement("div");return s.className="message user mb-6 flex justify-end",s.id=`message-${e}`,s.innerHTML=`\n            <div class="bg-blue-900 text-white p-4 rounded-2xl rounded-tr-none shadow-md max-w-[80%]">\n                <p>${t}</p>\n                <div class="flex justify-end mt-1">\n                    <span class="text-xs text-blue-200">${(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</span>\n                </div>\n            </div>\n        `,this.container.appendChild(s),this.scrollToBottom(),s}clearConversation(){this.container.innerHTML=""}}class a{setItem(e,t){localStorage.setItem(e,t)}getItem(e){return localStorage.getItem(e)}removeItem(e){localStorage.removeItem(e)}}document.addEventListener("DOMContentLoaded",(()=>{const t=new a,l=new o,d=new i(document.getElementById("conversation-list")),c=new s,u=new n,m=new r;let h=null,g=[],p=!1,b=!1,y=!1,E=0;!function(){if("function"==typeof Swiper)return new Swiper(".swiper-container",{direction:"horizontal",loop:!0,slidesPerView:1,spaceBetween:0,width:null,touchEventsTarget:"container",touchRatio:1,touchAngle:45,simulateTouch:!0,shortSwipes:!0,grabCursor:!0,pagination:{el:".swiper-pagination",clickable:!0},effect:"slide",speed:400});console.error("La bibliothèque Swiper n'est pas chargée.")}();const v=t.getItem("groq-api-key");v&&l.setApiKey(v),document.getElementById("api-key").addEventListener("change",(()=>{t.setItem("groq-api-key",l.getApiKey())})),m.onSpeakingStarted=()=>{h&&(h.start(),l.updateUI(!0,!1))},m.onSpeakingEnded=()=>{},m.onSpeakingInterrupted=()=>{b=!0},document.getElementById("start-button").addEventListener("click",(async()=>{try{if(h=new e({onSpeechStart:()=>{m.isSpeaking&&(y=!0,m.cancel(),c.cancel(),u.cancel(),p=!1),h.isMuted()||l.updateUI(!0,!0)},onSpeechEnd:e=>{!h.isMuted()&&e?.length>=100&&(l.updateUI(!0,!1),async function(e){if(!e||e.length<100)return;g.push(e);const t=++E;l.addSegment(g.length,e.length/16e3);try{p=!0,l.updateUI(!0,!1,!0),h.pause(),d.addPendingUserMessage(t);const s=l.getApiKey();if(!s)throw new Error("Aucune clé API");const n=await c.transcribe(e,s);if(n.toLowerCase().includes("fin de discussion"))return void w();if(!n.toLowerCase().includes("monsieur"))return w(),void setTimeout((()=>{document.getElementById("start-button").click()}),500);d.updateUserMessage(t,n),d.addPendingAssistantMessage(t);const r=await u.sendMessage(n,s);d.updateAssistantMessage(t,r),b=!1;try{await m.speak(r)}catch(e){console.error("Erreur synthèse vocale:",e)}}catch(e){"AbortError"!==e.name&&(console.error("Erreur:",e),d.addInfoMessage(`Erreur: ${e.message}`,"error"))}finally{p=!1,!b&&h?.isListening()&&l.updateUI(!0,!1)}}(e),y=!1)},onError:e=>{console.error("Erreur de détection vocale:",e),d.addInfoMessage(`Erreur: ${e.message}`,"error")}}),!await h.initialize())throw new Error("Échec de l'initialisation");h.start(),l.updateUI(!0,!1),d.addInfoMessage("Détection vocale démarrée","success")}catch(e){console.error("Erreur:",e),d.addInfoMessage(`Erreur: ${e.message}`,"error")}})),document.getElementById("stop-button").addEventListener("click",(()=>{w()})),document.getElementById("mute-button").addEventListener("click",(()=>{h&&(h.setMute(!h.isMuted()),l.updateMuteState(h.isMuted()))}));const S=document.getElementById("text-input-form");function w(){h&&h.stop(),c.cancel(),u.cancel(),m.cancel(),p=!1,b=!1,y=!1,l.updateUI(!1),d.addInfoMessage("Session arrêtée","info")}S&&S.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("text-input"),s=t.value.trim();if(s)try{const e=l.getApiKey();if(!e)throw new Error("Aucune clé API");const n=++E;d.addUserTextMessage(n,s),t.value="",t.disabled=!0,document.getElementById("send-text-button").disabled=!0,d.addPendingAssistantMessage(n);const r=await u.sendMessage(s,e);d.updateAssistantMessage(n,r);try{await m.speak(r)}catch(e){console.error("Erreur TTS:",e)}}catch(e){console.error("Erreur:",e),d.addInfoMessage(`Erreur: ${e.message}`,"error")}finally{t.disabled=!1,t.focus(),document.getElementById("send-text-button").disabled=!1}}));const f=document.querySelector("button.bg-emerald-50");f&&f.addEventListener("click",(()=>{w(),d.clearConversation(),g=[],l.resetSegments(),u.clearHistory(),E=0,d.addInfoMessage("Conversation réinitialisée","success")}))}))})();